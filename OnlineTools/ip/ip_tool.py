import requests
import os
import time
import re
import json
from util._radom import get_radom
from util.exjs import get_js
from util.filter_cookie import filter_cookie

class IP(object):
    def __init__(self,ip):
        self.ip = ip
    def get_ip_data(self):
        path = os.path.dirname(os.path.dirname(__file__))
        cookie_request_url = "http://ip.tool.chinaz.com/"+self.ip
        cookie_request_header = {
            "Host": "ip.tool.chinaz.com",
            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
            "Accept-Encoding": "gzip, deflate",
            "Content-Type": "application/x-www-form-urlencoded",
            "Content-Length": "15",
            "Origin": "http://ip.tool.chinaz.com",
            "Connection": "keep-alive",
            "Referer": "http://ip.tool.chinaz.com/"+self.ip,
            "Upgrade-Insecure-Requests": "1",
            "Pragma": "no-cache",
            "Cache-Control": "no-cache",
        }
        cookie_response = requests.post(url=cookie_request_url,headers = cookie_request_header,data=self.ip)
        ck = filter_cookie(cookie_response)
        del cookie_response
        token = get_js(js_url=path+"/ip/generateKey.js",fun_name="gettoken",param=self.ip)
        radom_13 = get_radom("0123456789",13)
        request_url = "http://ip.tool.chinaz.com/ajaxsync.aspx?at=AiWenBaseData&callback=jQuery11130"+radom_13+"_"+str(int(time.time()*1000))
        request_header = {
            "Host": "ip.tool.chinaz.com",
            "User-Agent": "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0",
            "Accept": "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01",
            "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
            "Accept-Encoding": "gzip, deflate",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            "Cookie":ck,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Length": "74",
            "Origin": "http://ip.tool.chinaz.com",
            "Connection": "keep-alive",
            "Referer": "http://ip.tool.chinaz.com/"+self.ip,
            "Pragma": "no-cache",
            "Cache-Control": "no-cache",
        }
        request_data = {
            "token": token.replace("%2C",","),
            "ip": self.ip,
            "aiWenType": "区县级数据"
        }
        response = requests.post(url=request_url,headers = request_header,data=request_data)
        data_re = re.findall(".*\((.*)\)",response.text)
        data_0 = data_re[0] if data_re else ""
        data_json = json.loads(data_0)["Body"][0] if data_0 else {}
        del response
        return data_json

if __name__ == "__main__":
    ip = IP("103.205.5.18")
    result = ip.get_ip_data()
    print(result)
    """
    {
    'StateCode': 1, 
    'Body': [{
        'accuracy': '城市', 
        'continent': '亚洲', 
        'country': '中国', 
        'zipcode': '213001', 
        'lat': '31.767346', 
        'lng': '119.970668', 
        'radius': '57.9084', 
        'prov': '江苏省', 
        'city': '常州市', 
        'district': '无数据', 
        'address': '无数据'
    }], 
    'Bounds': ['{
        "code":200,
        "data":{
            "bounds":
                [[[[31.506435,119.572364],[31.498591,119.571752],[31.486502,119.580523],[31.47748,119.578374],[31.476287,119.569769],[31.47014,119.570501],[31.4724,119.593714],[31.468795,119.597111],[31.45337,119.594963],[31.451738,119.588691],[31.442826,119.587784],[31.436458,119.582544],[31.438515,119.557772],[31.421528,119.557033],[31.414158,119.541427],[31.400515,119.546936],[31.371624,119.53337],[31.33724,119.535716],[31.32464,119.525212],[31.307531,119.528845],[31.297539,119.540387],[31.294213,119.536575],[31.284278,119.535915],[31.281952,119.540957],[31.275321,119.535669],[31.265342,119.537432],[31.258703,119.532312],[31.254235,119.533974],[31.248572,119.527792],[31.243079,119.539696],[31.227044,119.559161],[31.222219,119.556032],[31.185148,119.558841],[31.18143,119.547874],[31.165425,119.537772],[31.166162,119.528658],[31.162396,119.519097],[31.17069,119.494378],[31.158409,119.487801],[31.164689,119.481155],[31.163421,119.46276],[31.176655,119.452981],[31.18295,119.444109],[31.18338,119.435706],[31.187919,119.433778],[31.188013,119.428411],[31.179314,119.42093],[31.185132,119.405765],[31.180225,119.402469],[31.180608,119.396655],[31.194667,119.394494],[31.199734,119.400516],[31.20079,119.410825],[31.205973,119.400089],[31.198085,119.394445],[31.201014,119.393877],[31.195597,119.379953],[31.203994,119.376494],[31.201889,119.37107],[31.208477,119.367708],[31.217985,119.365412],[31.238578,119.37051],[31.244551,119.3687],[31.248838,119.37609],[31.264445,119.379909],[31.26793,119.385927],[31.275579,119.384925],[31.277637,119.376834],[31.295209,119.373124],[31.309082,119.361946],[31.306734,119.355481],[31.286631,119.355538],[31.281008,119.350435],[31.274672,119.351302],[31.26456,119.342911],[31.269848,119.338587],[31.271629,119.324088],[31.269525,119.300001],[31.256744,119.272187],[31.267557,119.26662],[31.277694,119.250143],[31.286788,119.243853],[31.287056,119.23369],[31.283256,119.226738],[31.284846,119.221721],[31.291037,119.219234],[31.30242,119.222469],[31.309442,119.218217],[31.311666,119.211344],[31.303038,119.194541],[31.306612,119.186803],[31.307394,119.193603],[31.313899,119.194106],[31.316208,119.201085],[31.323079,119.198606],[31.336559,119.204472],[31.356007,119.224378],[31.361616,119.219504],[31.363675,119.209842],[31.374676,119.205638],[31.385392,119.195026],[31.387244,119.179307],[31.400388,119.174358],[31.427856,119.174395],[31.447284,119.169587],[31.445011,119.160725],[31.451175,119.146147],[31.45739,119.146373],[31.464273,119.154217],[31.481995,119.161144],[31.486845,119.161051],[31.493272,119.153829],[31.499548,119.158206],[31.499838,119.171586],[31.504318,119.176937],[31.506372,119.188779],[31.515586,119.192205],[31.526698,119.20271],[31.532844,119.185574],[31.544326,119.186303],[31.557641,119.193946],[31.557898,119.20338],[31.562689,119.210618],[31.568911,119.211817],[31.5761,119.22117],[31.591108,119.22163],[31.63279,119.239405],[31.631,119.242278],[31.649187,119.287948],[31.677297,119.322018],[31.706472,119.334041],[31.70975,119.334013],[31.713495,119.326418],[31.715942,119.330186],[31.721676,119.327009],[31.731052,119.335366],[31.738427,119.327015],[31.739177,119.310915],[31.771732,119.309872],[31.790399,119.324994],[31.800457,119.324719],[31.804818,119.31881],[31.816173,119.322248],[31.821488,119.319602],[31.831681,119.325583],[31.842067,119.338004],[31.846911,119.339595],[31.855089,119.335276],[31.864052,119.344304],[31.864036,119.36902],[31.851864,119.377706],[31.85295,119.39226],[31.839992,119.40553],[31.835593,119.427585],[31.838805,119.433372],[31.831747,119.438579],[31.834752,119.448731],[31.846393,119.437345],[31.858625,119.430891],[31.857933,119.425562],[31.863607,119.423107],[31.872593,119.432057],[31.877417,119.4288],[31.882425,119.443219],[31.891145,119.45416],[31.886897,119.46929],[31.877697,119.472996],[31.877932,119.481983],[31.86422,119.499291],[31.858036,119.513175],[31.8625,119.555312],[31.868588,119.562721],[31.861955,119.565234],[31.851442,119.594228],[31.841065,119.597456],[31.832696,119.594765],[31.833632,119.602707],[31.829354,119.604003],[31.827981,119.610476],[31.812049,119.611025],[31.802872,119.618658],[31.803032,119.630804],[31.80751,119.634819],[31.80193,119.649796],[31.795135,119.649965],[31.780567,119.660113],[31.774985,119.69371],[31.761141,119.70014],[31.752818,119.712051],[31.743616,119.713668],[31.737426,119.745787],[31.749818,119.73995],[31.768239,119.741524],[31.782786,119.752359],[31.791935,119.752775],[31.793331,119.763755],[31.814534,119.769136],[31.814261,119.797156],[31.822897,119.790737],[31.82758,119.796079],[31.832626,119.795616],[31.839187,119.805827],[31.857955,119.817164],[31.858269,119.787496],[31.853977,119.775134],[31.863283,119.768525],[31.878979,119.769229],[31.892007,119.758869],[31.893959,119.758861],[31.891599,119.763469],[31.907172,119.777004],[31.90899,119.786935],[31.919273,119.787533],[31.923876,119.781179],[31.922473,119.774229],[31.931828,119.774433],[31.929018,119.789418],[31.93211,119.796468],[31.936072,119.788737],[31.943074,119.789684],[31.944617,119.783819],[31.947567,119.785532],[31.955671,119.772844],[31.990353,119.783352],[31.992752,119.780842],[32.012475,119.78495],[32.017529,119.790266],[32.020529,119.782635],[32.060839,119.806374],[32.061558,119.827194],[32.05763,119.834364],[32.060368,119.845238],[32.066145,119.851225],[32.063872,119.859617],[32.057743,119.865192],[32.064447,119.874817],[32.048582,119.883798],[32.045758,119.888568],[32.053115,119.897332],[32.051005,119.903385],[32.043914,119.9033],[32.019572,119.913929],[32.011808,119.923271],[32.008427,119.954873],[32.022232,119.980431],[31.986483,120.01077],[31.973962,120.027634],[31.959748,120.018948],[31.957683,120.013979],[31.943381,120.012563],[31.925897,120.027641],[31.917876,120.010756],[31.900732,120.002995],[31.895519,120.011475],[31.889241,120.014173],[31.888149,120.01987],[31.865544,120.008442],[31.860942,119.995258],[31.850241,120.004973],[31.844114,120.005006],[31.844997,120.008878],[31.83221,120.010117],[31.834967,120.01321],[31.830391,120.024962],[31.838213,120.034039],[31.83211,120.037304],[31.827335,120.051012],[31.83905,120.061778],[31.859002,120.090774],[31.861412,120.122579],[31.865754,120.127991],[31.865109,120.149459],[31.868631,120.151406],[31.875927,120.17414],[31.876241,120.180209],[31.871327,120.189969],[31.857459,120.19346],[31.841827,120.175357],[31.840709,120.169396],[31.836121,120.169273],[31.821742,120.172939],[31.816375,120.183385],[31.804703,120.181812],[31.796312,120.189647],[31.759153,120.207141],[31.755609,120.189301],[31.764352,120.185067],[31.763771,120.177731],[31.766727,120.174353],[31.762232,120.159742],[31.709783,120.162156],[31.705161,120.158887],[31.703232,120.15053],[31.694533,120.148236],[31.689671,120.157811],[31.682276,120.148507],[31.690675,120.133622],[31.637304,120.124647],[31.635582,120.114038],[31.628142,120.107726],[31.611717,120.080726],[31.601145,120.080244],[31.582054,120.062296],[31.576263,120.065869],[31.567784,120.062466],[31.56122,120.068946],[31.558101,120.074709],[31.560297,120.082172],[31.555373,120.089159],[31.554428,120.104423],[31.528155,120.110641],[31.520323,120.108231],[31.519155,120.114892],[31.522554,120.12583],[31.51475,120.124739],[31.511856,120.13365],[31.487334,120.113953],[31.476797,120.110908],[31.467889,120.115283],[31.455839,120.084086],[31.439994,120.060142],[31.412036,120.049881],[31.38402,120.045017],[31.370383,120.045481],[31.364625,120.050197],[31.358638,120.101402],[31.341548,120.105389],[31.338467,120.094873],[31.351746,120.047097],[31.371143,120.028937],[31.389236,120.026287],[31.415156,120.03308],[31.431819,120.042886],[31.496713,120.051021],[31.510906,120.023693],[31.509702,120.010729],[31.514502,120.002325],[31.50388,120.001295],[31.521935,119.978805],[31.542001,119.976963],[31.549071,119.953702],[31.558405,119.940983],[31.553974,119.913986],[31.552486,119.867091],[31.535773,119.853069],[31.530782,119.838765],[31.546446,119.812127],[31.560171,119.771954],[31.567707,119.739628],[31.562263,119.719414],[31.581716,119.715335],[31.582231,119.705163],[31.609827,119.690295],[31.609278,119.682745],[31.615329,119.678318],[31.616406,119.666379],[31.611104,119.649317],[31.606653,119.644574],[31.588759,119.647874],[31.584065,119.651976],[31.579346,119.649641],[31.565818,119.632674],[31.564232,119.618252],[31.5391,119.600339],[31.509974,119.58852],[31.512526,119.57423],[31.506435,119.572364]]]],
            "bdLon":"119.981861",
            "bdLat":"31.771397"
        },
        "msg":"查询成功"
        }']
    }
    """